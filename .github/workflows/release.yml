# Package Release Workflow
#
# Automatically releases both @jsonbored/opennextjs-cli and @jsonbored/opennextjs-mcp
# packages to npm when a version tag is pushed. Supports both NPM_TOKEN (for first release)
# and OIDC (for subsequent releases). Both packages are released with synchronized versions.
#
# **What it does:**
# 1. Builds both packages (CLI and MCP)
# 2. Extracts version from tag (e.g., v1.0.0 â†’ 1.0.0)
# 3. Verifies both package.json versions match tag version
# 4. Generates changelog automatically using git-cliff
# 5. Publishes both packages to npm (tries OIDC first, falls back to NPM_TOKEN)
# 6. Creates GitHub Release with changelog notes
#
# **Trigger:**
# Push a version tag:
# ```bash
# git tag v1.0.0
# git push origin main --tags
# ```
#
# **Prerequisites:**
# - package.json version must match tag version (e.g., 1.0.0)
#
# **First Release (NPM_TOKEN):**
# - Requires NPM_TOKEN secret in GitHub repository
# - Create token: npmjs.com â†’ Account Settings â†’ Access Tokens â†’ Generate New Token (Automation)
# - Add secret: GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
# - Name: NPM_TOKEN
# - Value: Your npm automation token
#
# **Subsequent Releases (OIDC - Recommended):**
# - After first release, set up OIDC trusted publishing:
#   1. Go to npmjs.com â†’ Account Settings â†’ Access Tokens â†’ Automation
#   2. Click "Add GitHub Actions" or "Configure" next to "Trusted Publishers"
#   3. Select repository: JSONbored/opennextjs-cli
#   4. Select workflow: .github/workflows/release.yml
#   5. Save
# - Once OIDC is configured, NPM_TOKEN is no longer needed
# - More secure than token-based authentication
# - Automatic token rotation
name: Release

on:
  push:
    tags:
      - 'v*.*.*'      # Matches v1.2.3

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: write # Required to create GitHub releases
      id-token: write # Required for npm publish (OIDC)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for changelog generation

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI package
        working-directory: packages/opennextjs-cli
        run: pnpm build

      - name: Build MCP package
        working-directory: packages/opennextjs-mcp
        run: pnpm build

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v1.0.0 â†’ 1.0.0)
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${TAG_NAME#v}"
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Verify CLI package.json version matches tag
        working-directory: packages/opennextjs-cli
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ CLI version mismatch: package.json ($PACKAGE_VERSION) != tag ($TAG_VERSION)" >&2
            exit 1
          fi
          echo "âœ… CLI version match: $PACKAGE_VERSION"

      - name: Verify MCP package.json version matches tag
        working-directory: packages/opennextjs-mcp
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ MCP version mismatch: package.json ($PACKAGE_VERSION) != tag ($TAG_VERSION)" >&2
            exit 1
          fi
          echo "âœ… MCP version match: $PACKAGE_VERSION"

      - name: Check if git-cliff is installed
        id: git-cliff-check
        run: |
          if command -v git-cliff &> /dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install git-cliff (if needed)
        if: steps.git-cliff-check.outputs.installed == 'false'
        run: |
          # Install git-cliff on Ubuntu
          sudo apt-get update && sudo apt-get install -y git-cliff || \
            echo "âš ï¸ git-cliff installation failed, will skip changelog generation" >&2

      - name: Generate changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Generate changelog with git-cliff (writes to root CHANGELOG.md)
          git-cliff \
            --config cliff.toml \
            --tag "v$TAG_VERSION" \
            --verbose || \
            echo "âš ï¸ Changelog generation failed, will continue without it" >&2
          
          # Extract changelog section for this version
          if [ -f CHANGELOG.md ]; then
            # Extract the section for this version
            awk "/^## \\[$TAG_VERSION\\]/,/^## \\[/ {if (/^## \\[/ && !/^## \\[$TAG_VERSION\\]/) exit; print}" CHANGELOG.md > /tmp/changelog-section.md || \
              echo "## [$TAG_VERSION] - $(date +%Y-%m-%d)" > /tmp/changelog-section.md
          else
            echo "## [$TAG_VERSION] - $(date +%Y-%m-%d)" > /tmp/changelog-section.md
            echo "" >> /tmp/changelog-section.md
            echo "Release $TAG_VERSION" >> /tmp/changelog-section.md
          fi
          
          echo "CHANGELOG_SECTION<<EOF" >> $GITHUB_ENV
          cat /tmp/changelog-section.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Publish CLI to npm (try OIDC first)
        id: publish-cli-oidc
        working-directory: packages/opennextjs-cli
        run: |
          # Try publishing with OIDC (if configured)
          npm publish --access public && \
          echo "âœ… Published @jsonbored/opennextjs-cli@${{ steps.version.outputs.VERSION }} to npm (via OIDC)" || \
          echo "âš ï¸ OIDC publish failed, will try NPM_TOKEN fallback"
        continue-on-error: true

      - name: Publish CLI to npm (fallback to NPM_TOKEN)
        if: steps.publish-cli-oidc.outcome == 'failure'
        working-directory: packages/opennextjs-cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NPM_TOKEN secret not found. For first release, you need to:" >&2
            echo "   1. Create npm automation token: https://www.npmjs.com/settings/JSONbored/tokens" >&2
            echo "   2. Add NPM_TOKEN secret to GitHub: Settings â†’ Secrets and variables â†’ Actions" >&2
            echo "   3. Name the secret: NPM_TOKEN" >&2
            exit 1
          fi
          # Configure npm to use token
          echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" > ~/.npmrc
          npm publish --access public
          echo "âœ… Published @jsonbored/opennextjs-cli@${{ steps.version.outputs.VERSION }} to npm (via NPM_TOKEN)"

      - name: Publish MCP to npm (try OIDC first)
        id: publish-mcp-oidc
        working-directory: packages/opennextjs-mcp
        run: |
          # Try publishing with OIDC (if configured)
          npm publish --access public && \
          echo "âœ… Published @jsonbored/opennextjs-mcp@${{ steps.version.outputs.VERSION }} to npm (via OIDC)" || \
          echo "âš ï¸ OIDC publish failed, will try NPM_TOKEN fallback"
        continue-on-error: true

      - name: Publish MCP to npm (fallback to NPM_TOKEN)
        if: steps.publish-mcp-oidc.outcome == 'failure'
        working-directory: packages/opennextjs-mcp
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "âŒ NPM_TOKEN secret not found" >&2
            exit 1
          fi
          # Configure npm to use token (if not already configured)
          if [ ! -f ~/.npmrc ]; then
            echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" > ~/.npmrc
          fi
          npm publish --access public
          echo "âœ… Published @jsonbored/opennextjs-mcp@${{ steps.version.outputs.VERSION }} to npm (via NPM_TOKEN)"
          echo "" >&2
          echo "ðŸ’¡ After first release, set up OIDC trusted publishing for both packages:" >&2
          echo "   1. Go to: https://www.npmjs.com/settings/JSONbored/automation" >&2
          echo "   2. Add trusted publisher for @jsonbored/opennextjs-cli" >&2
          echo "   3. Add trusted publisher for @jsonbored/opennextjs-mcp" >&2
          echo "   4. Both use: repository JSONbored/opennextjs-cli, workflow .github/workflows/release.yml" >&2
          echo "   Then you can remove the NPM_TOKEN secret." >&2

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Packages Released
            
            - `@jsonbored/opennextjs-cli@${{ steps.version.outputs.VERSION }}`
            - `@jsonbored/opennextjs-mcp@${{ steps.version.outputs.VERSION }}`
            
            ${{ env.CHANGELOG_SECTION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
